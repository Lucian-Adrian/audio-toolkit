
## Phase 5: Interactive Wizard (TUI)

**Goal:** Create a user-friendly terminal interface for guided configuration.

**Requirements Addressed:** U-013, WIZARD-001 to WIZARD-008

### Atomic Tasks

#### 5.1 Wizard Infrastructure

- [ ] **5.1.1** Add InquirerPy to requirements.txt
  ```
  InquirerPy>=0.3.4
  ```

- [ ] **5.1.2** Create `src/presentation/wizard/__init__.py`

- [ ] **5.1.3** Create `src/presentation/wizard/components.py` with reusable prompts
  ```python
  from InquirerPy import inquirer
  from InquirerPy.validator import PathValidator
  
  def prompt_file_or_directory(message: str = "Select input") -> Path:
      """Prompt for file or directory selection."""
      
  def prompt_choice(message: str, choices: list[str]) -> str:
      """Prompt for single choice selection."""
      
  def prompt_number(message: str, min_val: float, max_val: float, default: float) -> float:
      """Prompt for numeric input with validation."""
      
  def prompt_confirm(message: str, default: bool = True) -> bool:
      """Prompt for yes/no confirmation."""
  ```

- [ ] **5.1.4** Create `src/presentation/wizard/preset_manager.py`
  ```python
  class PresetManager:
      PRESET_DIR = Path.home() / ".audiotoolkit" / "presets"
      
      def save_preset(self, name: str, operation: str, config: dict) -> Path:
          """Save configuration as YAML preset."""
          
      def load_preset(self, name: str) -> dict:
          """Load preset by name."""
          
      def list_presets(self) -> list[str]:
          """List all saved presets."""
          
      def delete_preset(self, name: str) -> None:
          """Delete a preset."""
  ```

#### 5.2 Wizard Flows

- [ ] **5.2.1** Create `src/presentation/wizard/main_menu.py`
  ```python
  from rich.console import Console
  from rich.panel import Panel
  
  console = Console()
  
  def launch():
      """Launch the main wizard menu."""
      console.print(Panel.fit(
          "ğŸµ Audio Toolkit v1.0\nInteractive Wizard Mode",
          border_style="blue"
      ))
      
      choice = inquirer.select(
          message="What would you like to do?",
          choices=[
              {"name": "ğŸ”ª Split audio files", "value": "split"},
              {"name": "ğŸ”„ Convert formats", "value": "convert"},
              {"name": "ğŸ“Š Analyze audio", "value": "analyze"},
              {"name": "ğŸ¤ Voice enhancement", "value": "voice"},
              {"name": "â›“ï¸  Run pipeline", "value": "pipeline"},
              {"name": "âš™ï¸  Settings", "value": "settings"},
              {"name": "âŒ Exit", "value": "exit"},
          ]
      ).execute()
      
      if choice == "split":
          from .split_wizard import run_split_wizard
          run_split_wizard()
      # ... etc
  ```

- [ ] **5.2.2** Create `src/presentation/wizard/split_wizard.py`
  ```python
  def run_split_wizard():
      """Interactive wizard for split operations."""
      
      # Step 1: Select mode
      mode = prompt_choice("Select split mode", [
          "Fixed duration (e.g., 30-second chunks)",
          "Silence detection (split at pauses)",
          "Timestamp file (CSV/JSON/TXT)"
      ])
      
      # Step 2: Mode-specific parameters
      if mode.startswith("Fixed"):
          duration = prompt_number("Enter chunk duration (seconds)", 1, 3600, 30)
          
      # Step 3: Select input
      input_path = prompt_file_or_directory("Select input file or directory")
      
      # Step 4: Select output
      output_dir = prompt_file_or_directory("Select output directory")
      
      # Step 5: Show summary
      show_config_summary(config)
      
      # Step 6: Confirm and execute
      if prompt_confirm("Proceed with this configuration?"):
          execute_split(config)
          
          # Step 7: Offer to save preset
          if prompt_confirm("Save as preset for future use?", default=False):
              name = inquirer.text("Preset name").execute()
              PresetManager().save_preset(name, "split", config)
  ```

- [ ] **5.2.3** Create `src/presentation/wizard/convert_wizard.py`
  ```python
  def run_convert_wizard():
      """Interactive wizard for convert operations."""
  ```

- [ ] **5.2.4** Write tests (`tests/unit/test_wizard.py`)
  ```python
  def test_preset_save_load():
      """Test preset saving and loading."""
      
  def test_preset_list():
      """Test listing presets."""
  ```

#### 5.3 CLI Integration

- [ ] **5.3.1** Update `src/main.py` to launch wizard on no args
  ```python
  @app.callback(invoke_without_command=True)
  def main(
      ctx: typer.Context,
      wizard: bool = typer.Option(False, "--wizard", "-w"),
      preset: str | None = typer.Option(None, "--preset", "-p"),
  ):
      if preset:
          config = PresetManager().load_preset(preset)
          execute_from_preset(config)
      elif ctx.invoked_subcommand is None or wizard:
          from src.presentation.wizard.main_menu import launch
          launch()
  ```

### Verification Step
```bash
# Unit tests
pytest tests/unit/test_wizard.py -v

# Manual wizard test
audiotoolkit  # Should launch wizard (no args)
audiotoolkit --wizard  # Should launch wizard

# Test preset workflow
# 1. Run wizard, save preset as "my-split"
# 2. Run with preset
audiotoolkit --preset my-split
# Should execute without prompts

# Verify non-TTY detection
echo "test" | audiotoolkit
# Should show: "Wizard requires interactive terminal. Use CLI flags instead."
```

**Exit Criteria:**
- `audiotoolkit` (no args) launches wizard
- Wizard guides through all parameters
- Presets save/load correctly
- Non-interactive terminals show helpful error

---

## Phase 6: Plugin System

**Goal:** Enable third-party plugins to extend Audio Toolkit.

**Requirements Addressed:** PLUGIN-001 to PLUGIN-007, OPT-004

### Atomic Tasks

#### 6.1 Plugin Manager

- [ ] **6.1.1** Create `src/orchestration/plugin_manager.py`
  ```python
  from importlib.metadata import entry_points
  
  class PluginManager:
      _processors: dict[str, type[AudioProcessor]] = {}
      _instances: dict[str, AudioProcessor] = {}
      _disabled: set[str] = set()
      
      @classmethod
      def discover(cls) -> None:
          """Load built-in and third-party processors."""
          # Load built-ins
          cls._register_builtins()
          
          # Load from entry_points
          eps = entry_points(group="audiotoolkit.plugins")
          for ep in eps:
              cls._load_plugin(ep)
      
      @classmethod
      def _load_plugin(cls, ep) -> None:
          """Load single plugin with error handling."""
          try:
              plugin_class = ep.load()
              instance = plugin_class()
              
              # Validate interface
              if not isinstance(instance, AudioProcessor):
                  raise PluginInterfaceError(f"Must implement AudioProcessor")
              
              # Check for duplicates
              if instance.name in cls._instances:
                  logger.warning(f"Duplicate plugin: {instance.name}")
                  return
              
              cls._processors[instance.name] = plugin_class
              cls._instances[instance.name] = instance
              
          except Exception as e:
              logger.error(f"Failed to load plugin {ep.name}: {e}")
      
      @classmethod
      def get(cls, name: str) -> AudioProcessor:
          """Get processor by name."""
          
      @classmethod
      def list_all(cls) -> dict[str, AudioProcessor]:
          """List all registered processors."""
          
      @classmethod
      def disable(cls, name: str) -> None:
          """Disable a plugin (skip on next load)."""
  ```

- [ ] **6.1.2** Write tests (`tests/unit/test_plugin_manager.py`)
  ```python
  def test_discover_builtins():
      """All built-in processors discovered."""
      
  def test_get_processor():
      """Get processor by name."""
      
  def test_get_unknown_processor():
      """EC-PLUGIN-2: Unknown processor raises KeyError."""
      
  def test_invalid_plugin_skipped():
      """EC-PLUGIN-1: Invalid plugin logged and skipped."""
  ```

- [ ] **6.1.3** Create example plugin in `tests/fixtures/sample_plugin/`
  ```python
  # tests/fixtures/sample_plugin/my_plugin.py
  from src.core.interfaces import AudioProcessor, ProcessResult
  
  class EchoProcessor(AudioProcessor):
      @property
      def name(self) -> str:
          return "echo-test"
      
      @property
      def version(self) -> str:
          return "0.1.0"
      
      @property
      def description(self) -> str:
          return "Test plugin that copies input to output"
      
      def get_parameters(self) -> list:
          return []
      
      def process(self, input_path, output_dir, **kwargs) -> ProcessResult:
          import shutil
          output = output_dir / input_path.name
          shutil.copy(input_path, output)
          return ProcessResult(success=True, output_path=output, input_path=input_path)
  ```

#### 6.2 CLI Integration

- [ ] **6.2.1** Create `src/presentation/cli/plugin_cmd.py`
  ```python
  @app.command("list")
  def list_plugins():
      """List all available plugins."""
      table = Table(title="Registered Processors")
      table.add_column("Name")
      table.add_column("Version")
      table.add_column("Category")
      table.add_column("Description")
      
      for name, processor in PluginManager.list_all().items():
          table.add_row(name, processor.version, processor.category.value, processor.description)
      
      console.print(table)
  
  @app.command("info")
  def plugin_info(name: str):
      """Show detailed plugin information."""
      processor = PluginManager.get(name)
      # Display parameters, usage examples
  ```

### Verification Step
```bash
# Unit tests
pytest tests/unit/test_plugin_manager.py -v

# Verify built-in plugins
audiotoolkit plugins list
# Should show: splitter-fixed, splitter-silence, converter, etc.

# Verify plugin info
audiotoolkit plugins info splitter-fixed
# Should show: name, version, description, parameters

# Test with sample plugin (requires installing it)
pip install -e tests/fixtures/sample_plugin/
audiotoolkit plugins list
# Should include: echo-test
```

**Exit Criteria:**
- `plugins list` shows all built-in processors
- `plugins info` shows parameter details
- Third-party plugins discoverable via entry_points

---

## Phase 7: Advanced Processors

**Goal:** Implement remaining processors for analysis, voice enhancement, and transcription.

**Requirements Addressed:** VIS-*, STAT-*, NOISE-*, DYN-*, TRIM-*, TRANS-*

### Atomic Tasks

#### 7.1 Analysis Processors

- [ ] **7.1.1** Create `src/processors/visualizer.py`
  - Mel-spectrogram generation (librosa + matplotlib)
  - Waveform generation
  - Batch output with matching filenames

- [ ] **7.1.2** Create `src/processors/statistics.py`
  - RMS, peak amplitude, silence ratio calculation
  - Voice Activity Detection (VAD)
  - JSON export

- [ ] **7.1.3** Write tests (`tests/unit/test_analysis.py`)

#### 7.2 Voice Enhancement Processors

- [ ] **7.2.1** Create `src/processors/noise_reduce.py`
  - Spectral subtraction implementation
  - Configurable strength levels

- [ ] **7.2.2** Create `src/processors/dynamics.py`
  - Dynamic range compression
  - 3-band EQ with presets

- [ ] **7.2.3** Create `src/processors/trimmer.py`
  - Auto-trim silence from start/end
  - Configurable threshold

- [ ] **7.2.4** Write tests (`tests/unit/test_voice.py`)

#### 7.3 Transcriber

- [ ] **7.3.1** Create `src/processors/transcriber.py`
  - Whisper integration (local model)
  - Output formats: SRT, TXT
  - Filename matching

- [ ] **7.3.2** Write tests (`tests/unit/test_transcriber.py`)

#### 7.4 CLI Integration

- [ ] **7.4.1** Create `src/presentation/cli/analyze_cmd.py`
- [ ] **7.4.2** Create `src/presentation/cli/voice_cmd.py`
- [ ] **7.4.3** Update wizard with new operations

### Verification Step
```bash
# Unit tests for each processor
pytest tests/unit/test_analysis.py -v
pytest tests/unit/test_voice.py -v
pytest tests/unit/test_transcriber.py -v

# CLI tests
audiotoolkit analyze stats --input test.wav
audiotoolkit analyze visualize --type mel --input test.wav

audiotoolkit voice denoise --input test.wav
audiotoolkit voice trim --input test.wav

audiotoolkit transcribe --model whisper --input test.wav --output-format srt
```

**Exit Criteria:**
- All analysis commands produce correct output
- Voice enhancement improves audio quality
- Transcriber generates accurate SRT/TXT

---

## Phase 8: Polish & Release

**Goal:** Finalize documentation, testing, and prepare for PyPI release.

### Atomic Tasks

#### 8.1 Documentation

- [ ] **8.1.1** Update `README.md` with full usage examples
- [ ] **8.1.2** Update `docs/file-structure.md` with final structure
- [ ] **8.1.3** Create `docs/plugins/creating-plugins.md` guide
- [ ] **8.1.4** Update `CONTRIBUTING.md` with development setup
- [ ] **8.1.5** Create `CHANGELOG.md` with v1.0.0 release notes

#### 8.2 Testing & Quality

- [ ] **8.2.1** Achieve >90% test coverage
  ```bash
  pytest --cov=src --cov-report=html
  ```

- [ ] **8.2.2** Run full type checking
  ```bash
  mypy src/ --strict
  ```

- [ ] **8.2.3** Run linter and fix all issues
  ```bash
  ruff check src/ --fix
  black src/
  ```

- [ ] **8.2.4** Test on Windows, macOS, Linux

#### 8.3 Release

- [ ] **8.3.1** Update version to `1.0.0` in `pyproject.toml`
- [ ] **8.3.2** Build package
  ```bash
  python -m build
  ```
- [ ] **8.3.3** Test package installation
  ```bash
  pip install dist/audiotoolkit-1.0.0-py3-none-any.whl
  audiotoolkit --help
  ```
- [ ] **8.3.4** Publish to PyPI
  ```bash
  twine upload dist/*
  ```
- [ ] **8.3.5** Create GitHub release with changelog

### Verification Step
```bash
# Final verification checklist
pytest --cov=src --cov-fail-under=90
mypy src/ --strict
ruff check src/

# Fresh install test
pip uninstall audiotoolkit
pip install audiotoolkit
audiotoolkit --help
audiotoolkit split fixed --help
audiotoolkit plugins list
```

**Exit Criteria:**
- Package installable via `pip install audiotoolkit`
- All documentation complete
- >90% test coverage
- Released on PyPI

---

## Appendix: Task Tracking

### Progress Summary

| Phase | Total Tasks | Completed | Remaining |
|-------|-------------|-----------|-----------|
| Phase 0 | 10 | 0 | 10 |
| Phase 1 | 17 | 0 | 17 |
| Phase 2 | 16 | 0 | 16 |
| Phase 3 | 10 | 0 | 10 |
| Phase 4 | 9 | 0 | 9 |
| Phase 5 | 9 | 0 | 9 |
| Phase 6 | 5 | 0 | 5 |
| Phase 7 | 11 | 0 | 11 |
| Phase 8 | 13 | 0 | 13 |
| **Total** | **100** | **0** | **100** |

### Dependencies Graph

```
Phase 0 (Setup)
    â”‚
    â–¼
Phase 1 (Foundation)
    â”‚
    â–¼
Phase 2 (MVP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚
    â–¼                           â”‚
Phase 3 (Session) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼               â–¼
Phase 4         Phase 7
(Pipeline)      (Advanced)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼               â–¼
Phase 5         Phase 6
(Wizard)        (Plugin)
    â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
        Phase 8
        (Release)
```
