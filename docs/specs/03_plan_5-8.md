
## Phase 5: Interactive Wizard (TUI)

**Goal:** Create a user-friendly terminal interface for guided configuration.

**Requirements Addressed:** U-013, WIZARD-001 to WIZARD-008

### Atomic Tasks

#### 5.1 Wizard Infrastructure

- [x] **5.1.1** Add InquirerPy to requirements.txt
  ```
  InquirerPy>=0.3.4
  pyyaml>=6.0
  ```

- [x] **5.1.2** Create `src/presentation/wizard/__init__.py`

- [x] **5.1.3** Create `src/presentation/wizard/components.py` with reusable prompts
  - `prompt_file_or_directory()` - File/directory selection with path completion
  - `prompt_directory()` - Directory-only selection
  - `prompt_choice()` - Single choice selection
  - `prompt_multi_choice()` - Multiple choice selection
  - `prompt_number()` - Numeric input with range validation
  - `prompt_text()` - Text input with validation
  - `prompt_confirm()` - Yes/no confirmation
  - `show_config_summary()` - Display configuration panel
  - `show_error()`, `show_success()`, `show_warning()`, `show_info()` - Message panels
  - `is_interactive()` - TTY detection

- [x] **5.1.4** Create `src/presentation/wizard/preset_manager.py`
  - `PresetManager` class with YAML-based preset storage
  - `save_preset()` - Save configuration as YAML preset
  - `load_preset()` - Load preset by name
  - `list_presets()` - List all saved presets with optional filtering
  - `delete_preset()` - Delete a preset
  - `preset_exists()` - Check if preset exists
  - `get_preset_info()` - Get preset metadata
  - `export_preset()` / `import_preset()` - Import/export functionality
  - `PresetConfig` Pydantic model for validation

#### 5.2 Wizard Flows

- [x] **5.2.1** Create `src/presentation/wizard/main_menu.py`
  - `launch()` - Main wizard entry point
  - `show_welcome_banner()` - Display welcome panel
  - `show_main_menu()` - Interactive main menu
  - `is_interactive_terminal()` - TTY check
  - `show_non_interactive_error()` - Error for non-TTY mode
  - Menu options: Split, Convert, Analyze, Voice, Pipeline, Presets, Sessions, Settings, Exit
  - `execute_from_preset()` - Execute operation from saved preset
  - Preset management submenu (list, import, delete)

- [x] **5.2.2** Create `src/presentation/wizard/split_wizard.py`
  - `run_split_wizard()` - Complete split wizard flow
  - Mode selection: Fixed duration, Silence detection, Timestamp file
  - Mode-specific parameter configuration
  - Input file/directory selection with recursive option
  - Output directory and format selection
  - Configuration summary display
  - Execute with session management
  - Optional preset saving

- [x] **5.2.3** Create `src/presentation/wizard/convert_wizard.py`
  - `run_convert_wizard()` - Complete convert wizard flow
  - Format selection: MP3, WAV, FLAC, OGG, M4A
  - Quality settings per format (bitrate, sample format, compression)
  - Advanced options: sample rate, channels, normalize, remove silence
  - Configuration summary display
  - Execute with session management
  - Optional preset saving

- [x] **5.2.4** Write tests (`tests/unit/test_wizard.py`)
  - `TestPresetManager` - 12 tests for preset save/load/list/delete
  - `TestPresetConfig` - Validation tests
  - `TestWizardComponents` - UI component tests
  - `TestMainMenu` - Menu functionality tests
  - `TestSplitWizard` - Split wizard tests
  - `TestConvertWizard` - Convert wizard tests
  - `TestCLIIntegration` - CLI integration tests
  - `TestPresetExecution` - Preset execution tests

#### 5.3 CLI Integration

- [x] **5.3.1** Update `src/presentation/cli/__init__.py` to launch wizard on no args
  - Added `--wizard` / `-w` flag for explicit wizard mode
  - Added `--preset` / `-p` flag for preset execution
  - Added `--version` / `-V` flag for version info
  - Wizard launches when no subcommand provided
  - Non-interactive terminal detection with helpful error message

### Verification Step
```bash
# Unit tests (26 tests, all passing)
pytest tests/unit/test_wizard.py -v

# Full test suite (360 tests, all passing)
pytest tests/ -v

# Manual wizard test
audiotoolkit  # Should launch wizard (no args)
audiotoolkit --wizard  # Should launch wizard

# Test preset workflow
# 1. Run wizard, save preset as "my-split"
# 2. Run with preset
audiotoolkit --preset my-split
# Should execute without prompts

# Verify non-TTY detection
echo "test" | audiotoolkit
# Should show: "Wizard requires interactive terminal. Use CLI flags instead."

# Version info
audiotoolkit --version
# Should show: Audio Toolkit v0.1.0
```

**Exit Criteria:** ✅ COMPLETED
- ✅ `audiotoolkit` (no args) launches wizard
- ✅ Wizard guides through all parameters
- ✅ Presets save/load correctly
- ✅ Non-interactive terminals show helpful error

---

## Phase 6: Plugin System

**Goal:** Enable third-party plugins to extend Audio Toolkit.

**Requirements Addressed:** PLUGIN-001 to PLUGIN-007, OPT-004

### Atomic Tasks

#### 6.1 Plugin Manager

- [x] **6.1.1** Create `src/orchestration/plugin_manager.py`
  ```python
  from importlib.metadata import entry_points
  
  class PluginManager:
      _processors: dict[str, type[AudioProcessor]] = {}
      _instances: dict[str, AudioProcessor] = {}
      _disabled: set[str] = set()
      
      @classmethod
      def discover(cls) -> None:
          """Load built-in and third-party processors."""
          # Load built-ins
          cls._register_builtins()
          
          # Load from entry_points
          eps = entry_points(group="audiotoolkit.plugins")
          for ep in eps:
              cls._load_plugin(ep)
      
      @classmethod
      def _load_plugin(cls, ep) -> None:
          """Load single plugin with error handling."""
          try:
              plugin_class = ep.load()
              instance = plugin_class()
              
              # Validate interface
              if not isinstance(instance, AudioProcessor):
                  raise PluginInterfaceError(f"Must implement AudioProcessor")
              
              # Check for duplicates
              if instance.name in cls._instances:
                  logger.warning(f"Duplicate plugin: {instance.name}")
                  return
              
              cls._processors[instance.name] = plugin_class
              cls._instances[instance.name] = instance
              
          except Exception as e:
              logger.error(f"Failed to load plugin {ep.name}: {e}")
      
      @classmethod
      def get(cls, name: str) -> AudioProcessor:
          """Get processor by name."""
          
      @classmethod
      def list_all(cls) -> dict[str, AudioProcessor]:
          """List all registered processors."""
          
      @classmethod
      def disable(cls, name: str) -> None:
          """Disable a plugin (skip on next load)."""
  ```

- [x] **6.1.2** Write tests (`tests/unit/test_plugin_manager.py`)
  ```python
  def test_discover_builtins():
      """All built-in processors discovered."""
      
  def test_get_processor():
      """Get processor by name."""
      
  def test_get_unknown_processor():
      """EC-PLUGIN-2: Unknown processor raises KeyError."""
      
  def test_invalid_plugin_skipped():
      """EC-PLUGIN-1: Invalid plugin logged and skipped."""
  ```

- [x] **6.1.3** Create example plugin in `tests/fixtures/sample_plugin/`
  ```python
  # tests/fixtures/sample_plugin/my_plugin.py
  from src.core.interfaces import AudioProcessor, ProcessResult
  
  class EchoProcessor(AudioProcessor):
      @property
      def name(self) -> str:
          return "echo-test"
      
      @property
      def version(self) -> str:
          return "0.1.0"
      
      @property
      def description(self) -> str:
          return "Test plugin that copies input to output"
      
      def get_parameters(self) -> list:
          return []
      
      def process(self, input_path, output_dir, **kwargs) -> ProcessResult:
          import shutil
          output = output_dir / input_path.name
          shutil.copy(input_path, output)
          return ProcessResult(success=True, output_path=output, input_path=input_path)
  ```

#### 6.2 CLI Integration

- [x] **6.2.1** Create `src/presentation/cli/plugin_cmd.py`
  ```python
  @app.command("list")
  def list_plugins():
      """List all available plugins."""
      table = Table(title="Registered Processors")
      table.add_column("Name")
      table.add_column("Version")
      table.add_column("Category")
      table.add_column("Description")
      
      for name, processor in PluginManager.list_all().items():
          table.add_row(name, processor.version, processor.category.value, processor.description)
      
      console.print(table)
  
  @app.command("info")
  def plugin_info(name: str):
      """Show detailed plugin information."""
      processor = PluginManager.get(name)
      # Display parameters, usage examples
  ```

### Verification Step
```bash
# Unit tests
pytest tests/unit/test_plugin_manager.py -v

# Verify built-in plugins
audiotoolkit plugins list
# Should show: splitter-fixed, converter, etc.

# Verify plugin info
audiotoolkit plugins info splitter-fixed
# Should show: name, version, description, parameters

# Test with sample plugin (requires installing it)
pip install -e tests/fixtures/sample_plugin/
audiotoolkit plugins list
# Should include: echo-test
```

**Exit Criteria:** ✅ COMPLETED
- ✅ `plugins list` shows all built-in processors
- ✅ `plugins info` shows parameter details
- ✅ Third-party plugins discoverable via entry_points

---

## Phase 7: Advanced Processors

**Goal:** Implement remaining processors for analysis, voice enhancement, and transcription.

**Requirements Addressed:** VIS-*, STAT-*, NOISE-*, DYN-*, TRIM-*, TRANS-*

### Atomic Tasks

#### 7.1 Analysis Processors

- [ ] **7.1.1** Create `src/processors/visualizer.py`
  - Mel-spectrogram generation (librosa + matplotlib)
  - Waveform generation
  - Batch output with matching filenames

- [ ] **7.1.2** Create `src/processors/statistics.py`
  - RMS, peak amplitude, silence ratio calculation
  - Voice Activity Detection (VAD)
  - JSON export

- [ ] **7.1.3** Write tests (`tests/unit/test_analysis.py`)

#### 7.2 Voice Enhancement Processors

- [ ] **7.2.1** Create `src/processors/noise_reduce.py`
  - Spectral subtraction implementation
  - Configurable strength levels

- [ ] **7.2.2** Create `src/processors/dynamics.py`
  - Dynamic range compression
  - 3-band EQ with presets

- [ ] **7.2.3** Create `src/processors/trimmer.py`
  - Auto-trim silence from start/end
  - Configurable threshold

- [ ] **7.2.4** Write tests (`tests/unit/test_voice.py`)

#### 7.3 Transcriber

- [ ] **7.3.1** Create `src/processors/transcriber.py`
  - Whisper integration (local model)
  - Output formats: SRT, TXT
  - Filename matching

- [ ] **7.3.2** Write tests (`tests/unit/test_transcriber.py`)

#### 7.4 CLI Integration

- [ ] **7.4.1** Create `src/presentation/cli/analyze_cmd.py`
- [ ] **7.4.2** Create `src/presentation/cli/voice_cmd.py`
- [ ] **7.4.3** Update wizard with new operations

### Verification Step
```bash
# Unit tests for each processor
pytest tests/unit/test_analysis.py -v
pytest tests/unit/test_voice.py -v
pytest tests/unit/test_transcriber.py -v

# CLI tests
audiotoolkit analyze stats --input test.wav
audiotoolkit analyze visualize --type mel --input test.wav

audiotoolkit voice denoise --input test.wav
audiotoolkit voice trim --input test.wav

audiotoolkit transcribe --model whisper --input test.wav --output-format srt
```

**Exit Criteria:**
- All analysis commands produce correct output
- Voice enhancement improves audio quality
- Transcriber generates accurate SRT/TXT

---

## Phase 8: Polish & Release

**Goal:** Finalize documentation, testing, and prepare for PyPI release.

### Atomic Tasks

#### 8.1 Documentation

- [ ] **8.1.1** Update `README.md` with full usage examples
- [ ] **8.1.2** Update `docs/file-structure.md` with final structure
- [ ] **8.1.3** Create `docs/plugins/creating-plugins.md` guide
- [ ] **8.1.4** Update `CONTRIBUTING.md` with development setup
- [ ] **8.1.5** Create `CHANGELOG.md` with v1.0.0 release notes

#### 8.2 Testing & Quality

- [ ] **8.2.1** Achieve >90% test coverage
  ```bash
  pytest --cov=src --cov-report=html
  ```

- [ ] **8.2.2** Run full type checking
  ```bash
  mypy src/ --strict
  ```

- [ ] **8.2.3** Run linter and fix all issues
  ```bash
  ruff check src/ --fix
  black src/
  ```

- [ ] **8.2.4** Test on Windows, macOS, Linux

#### 8.3 Release

- [ ] **8.3.1** Update version to `1.0.0` in `pyproject.toml`
- [ ] **8.3.2** Build package
  ```bash
  python -m build
  ```
- [ ] **8.3.3** Test package installation
  ```bash
  pip install dist/audiotoolkit-1.0.0-py3-none-any.whl
  audiotoolkit --help
  ```
- [ ] **8.3.4** Publish to PyPI
  ```bash
  twine upload dist/*
  ```
- [ ] **8.3.5** Create GitHub release with changelog

### Verification Step
```bash
# Final verification checklist
pytest --cov=src --cov-fail-under=90
mypy src/ --strict
ruff check src/

# Fresh install test
pip uninstall audiotoolkit
pip install audiotoolkit
audiotoolkit --help
audiotoolkit split fixed --help
audiotoolkit plugins list
```

**Exit Criteria:**
- Package installable via `pip install audiotoolkit`
- All documentation complete
- >90% test coverage
- Released on PyPI

---

## Appendix: Task Tracking

### Progress Summary

| Phase | Total Tasks | Completed | Remaining |
|-------|-------------|-----------|-----------|
| Phase 0 | 10 | 0 | 10 |
| Phase 1 | 17 | 0 | 17 |
| Phase 2 | 16 | 0 | 16 |
| Phase 3 | 10 | 0 | 10 |
| Phase 4 | 9 | 0 | 9 |
| Phase 5 | 9 | 9 | 0 |
| Phase 6 | 5 | 5 | 0 |
| Phase 7 | 11 | 0 | 11 |
| Phase 8 | 13 | 0 | 13 |
| **Total** | **100** | **14** | **86** |

### Dependencies Graph

```
Phase 0 (Setup)
    │
    ▼
Phase 1 (Foundation)
    │
    ▼
Phase 2 (MVP) ──────────────────┐
    │                           │
    ▼                           │
Phase 3 (Session) ◄─────────────┤
    │                           │
    ├───────────────┬───────────┘
    ▼               ▼
Phase 4         Phase 7
(Pipeline)      (Advanced)
    │
    ├───────────────┐
    ▼               ▼
Phase 5         Phase 6
(Wizard)        (Plugin)
    │               │
    └───────┬───────┘
            ▼
        Phase 8
        (Release)
```
